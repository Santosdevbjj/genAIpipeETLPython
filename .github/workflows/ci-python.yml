name: CI Python

on:
  push:
    paths:
      - 'etl/**'
      - '.github/workflows/ci-python.yml'
  pull_request:
    paths:
      - 'etl/**'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps and Project
        run: |
          cd etl
          python -m venv .venv
          . .venv/bin/activate
          pip install -r requirements.txt
          pip install pytest-httpx
          # üí° NOVO: Instala o c√≥digo-fonte como um pacote edit√°vel (`-e`),
          # que √© a melhor pr√°tica para projetos com src/ para garantir que o 'etl' seja import√°vel.
          pip install -e . 

      - name: Run tests
        run: |
          # N√£o precisamos mais do `cd etl` aqui, pois a instala√ß√£o j√° configurou o path
          # e o ambiente virtual foi ativado.
          
          # Entramos no diret√≥rio etl para ativar o ambiente.
          cd etl
          . .venv/bin/activate
          
          # üí° NOVO: Executamos o pytest no diret√≥rio PAI (o diret√≥rio 'etl'),
          # mas apontamos explicitamente para os testes em 'tests/'.
          # O pytest consegue encontrar o pacote 'etl' porque ele foi instalado
          # no passo anterior (`pip install -e .`).
          pytest tests -q
